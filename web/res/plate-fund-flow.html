<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>板块资金流向</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 8px 20px;
        }
        
        .container {
        }
        .controls {
            padding: 10px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .time-selector {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.active {
            background-color: #e74c3c;
        }
        
        table {
            width: 100%;
            font-size: 13px;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #34495e;
            color: white;
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        th:hover {
            background-color: #2c3e50;
        }
        
        th.sortable::after {
            content: " ↕";
            opacity: 0.5;
        }
        
        th.sort-asc::after {
            content: " ↑";
            opacity: 1;
        }
        
        th.sort-desc::after {
            content: " ↓";
            opacity: 1;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        tr:hover {
            background-color: #e8f4f8;
        }
        
        .positive {
            color: #27ae60;
            font-weight: bold;
        }
        
        .negative {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        
        .amount {
            text-align: right;
        }
        
        .percent {
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h3>板块资金流向</h3>
        </div>
        
        <div class="controls">
            <div class="time-selector">
                <button id="todayBtn" class="active">今日</button>
                <button id="fiveDayBtn">5日</button>
                <button id="tenDayBtn">10日</button>
            </div>
            <div class="info">
                <span id="totalCount">共0条记录</span>
            </div>
        </div>
        
        <div id="tableContainer">
            <div class="loading">正在加载数据...</div>
        </div>
    </div>

    <script>
        // API端点配置 - 使用后端代理
        const API_ENDPOINTS = {
            today: '/api/plate-funds-flow/today',
            fiveDay: '/api/plate-funds-flow/fiveDay',
            tenDay: '/api/plate-funds-flow/tenDay'
        };

        // 字段映射
        const FIELD_MAP = {
            f14: { label: '名称', sortable: true },
            f12: { label: '编号', sortable: true },
            f2: { label: '股价', sortable: true },
            f3: { label: '涨跌幅%', sortable: true },
            f62: { label: '主力净流入(万)', sortable: true },
            f184: { label: '主力净占比%', sortable: true },
            f66: { label: '超大单净流入(万)', sortable: true },
            f69: { label: '超大单净占比%', sortable: true },
            f72: { label: '大单净流入(万)', sortable: true },
            f75: { label: '大单净占比%', sortable: true },
            f78: { label: '中单净流入(万)', sortable: true },
            f81: { label: '中单净占比%', sortable: true },
            f84: { label: '小单净流入(万)', sortable: true },
            f87: { label: '小单净占比%', sortable: true },
            f204: { label: '主力净流入最大股', sortable: true }
        };

        // 当前状态
        let currentData = [];
        let currentSort = { field: null, direction: 'desc' };
        let currentPeriod = 'today';

        // DOM元素
        const tableContainer = document.getElementById('tableContainer');
        const totalCountEl = document.getElementById('totalCount');
        const todayBtn = document.getElementById('todayBtn');
        const fiveDayBtn = document.getElementById('fiveDayBtn');
        const tenDayBtn = document.getElementById('tenDayBtn');

        // 格式化数值
        function formatNumber(num, decimals = 2) {
            if (num === undefined || num === null) return '-';
            
            // 如果是百分比，保留一位小数
            if (Math.abs(num) < 100 && Math.abs(num) !== Math.floor(Math.abs(num))) {
                return num.toFixed(2) + '%';
            }
            
            // 对于大额资金，转换为万元单位
            if (Math.abs(num) >= 10000) {
                return (num / 10000).toFixed(decimals) + '万';
            }
            
            return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }

        // 获取数据
        async function fetchData(period) {
            try {
                tableContainer.innerHTML = '<div class="loading">正在加载数据...</div>';

                const response = await fetch(API_ENDPOINTS[period]);
                const result = await response.json();

                if (!result.success || !result.data?.data?.diff) {
                    throw new Error(result.error || '数据获取失败');
                }

                currentData = result.data.data.diff;
                totalCountEl.textContent = `共${currentData.length}条记录`;

                renderTable(currentData);
            } catch (error) {
                console.error('获取数据失败:', error);
                tableContainer.innerHTML = `<div class="error">加载数据失败: ${error.message}</div>`;
            }
        }

        // 渲染表格
        function renderTable(data) {
            if (!data || data.length === 0) {
                tableContainer.innerHTML = '<div class="error">暂无数据</div>';
                return;
            }

            // 创建表头
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
            `;
            
            for (const [field, config] of Object.entries(FIELD_MAP)) {
                const className = config.sortable ? 'sortable' : '';
                const sortClass = 
                    currentSort.field === field ? 
                    (currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc') : 
                    '';
                    
                tableHTML += `
                    <th 
                        class="${className} ${sortClass}" 
                        data-field="${field}"
                        title="点击排序"
                    >
                        ${config.label}
                    </th>
                `;
            }
            
            tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 创建表格内容
            data.forEach(item => {
                tableHTML += '<tr>';
                
                for (const [field] of Object.entries(FIELD_MAP)) {
                    let cellValue = item[field];
                    let cellClass = '';
                    
                    // 特殊格式化
                    if (field === 'f3' || field === 'f184' || field === 'f69' || field === 'f75' || field === 'f81' || field === 'f87') {
                        // 百分比字段
                        cellValue = formatNumber(cellValue);
                        cellClass = cellValue && parseFloat(cellValue) >= 0 ? 'positive percent' : 'negative percent';
                    } else if (field === 'f2') {
                        // 股价字段
                        cellValue = formatNumber(cellValue, 2);
                        cellClass = cellValue && parseFloat(item.f3) >= 0 ? 'positive' : 'negative';
                    } else if (field === 'f62' || field === 'f66' || field === 'f72' || field === 'f78' || field === 'f84') {
                        // 资金流入字段（转换为万元）
                        cellValue = formatNumber(cellValue / 10000, 2);
                        cellClass = cellValue && parseFloat(cellValue) >= 0 ? 'positive amount' : 'negative amount';
                    } else {
                        // 其他字段
                        if (typeof cellValue === 'number') {
                            cellValue = formatNumber(cellValue, 2);
                        }
                    }
                    
                    tableHTML += `<td class="${cellClass}">${cellValue || '-'}</td>`;
                }
                
                tableHTML += '</tr>';
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
            
            // 添加排序事件监听器
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.getAttribute('data-field');
                    handleSort(field);
                });
            });
        }

        // 处理排序
        function handleSort(field) {
            // 如果点击的是同一个字段，则切换排序方向
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // 点击新字段，默认降序
                currentSort.field = field;
                currentSort.direction = 'desc';
            }
            
            // 执行排序
            const sortedData = [...currentData].sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                
                // 处理数字比较
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                }
                
                // 处理字符串比较
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return currentSort.direction === 'asc' ? 
                        valA.localeCompare(valB) : 
                        valB.localeCompare(valA);
                }
                
                // 混合类型比较
                valA = String(valA || '');
                valB = String(valB || '');
                
                return currentSort.direction === 'asc' ? 
                    valA.localeCompare(valB) : 
                    valB.localeCompare(valA);
            });
            
            renderTable(sortedData);
        }

        // 切换时间周期
        function switchPeriod(period) {
            currentPeriod = period;
            
            // 更新按钮状态
            todayBtn.classList.toggle('active', period === 'today');
            fiveDayBtn.classList.toggle('active', period === 'fiveDay');
            tenDayBtn.classList.toggle('active', period === 'tenDay');
            
            // 获取新数据
            fetchData(period);
        }

        // 初始化事件监听器
        todayBtn.addEventListener('click', () => switchPeriod('today'));
        fiveDayBtn.addEventListener('click', () => switchPeriod('fiveDay'));
        tenDayBtn.addEventListener('click', () => switchPeriod('tenDay'));

        // 初始化页面
        fetchData('today');
    </script>
</body>
</html>