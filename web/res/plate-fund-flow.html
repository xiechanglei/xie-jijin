<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>板块资金流向</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 8px 20px;
        }

        .controls {
            padding: 10px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .time-selector {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button.active {
            background-color: #dc3545;
        }
        
        table {
            width: 100%;
            font-size: 13px;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #34495e;
            color: white;
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        th:hover {
            background-color: #2c3e50;
        }
        
        th.sortable::after {
            content: " ↕";
            opacity: 0.5;
        }
        
        th.sort-asc::after {
            content: " ↑";
            opacity: 1;
        }
        
        th.sort-desc::after {
            content: " ↓";
            opacity: 1;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        tr:hover {
            background-color: #e8f4f8;
        }
        
        .positive {
            color: #e74c3c; /* 红色表示上涨 */
            font-weight: bold;
        }

        .negative {
            color: #27ae60; /* 绿色表示下跌 */
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        
        .amount {
            text-align: center;
        }

        .percent {
            text-align: center;
        }

        .search-container {
            flex-grow: 1;
            max-width: 300px;
        }

        #searchInput {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        #searchInput:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .info{
            margin-left: 20px;
            font-size: 14px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h3>板块资金流向</h3>
            <div class="time-selector">
                <button id="todayBtn" class="active">今日</button>
                <button id="fiveDayBtn">5日</button>
                <button id="tenDayBtn">10日</button>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="搜索名称或编号...">
            </div>
            <div class="info">
                <span id="totalCount">共0条记录</span>
            </div>
        </div>

        <div id="tableContainer">
            <div class="loading">正在加载数据...</div>
        </div>
    </div>

    <script>
        // API端点配置 - 使用后端代理
        const API_ENDPOINTS = {
            today: '/api/plate-funds-flow/today',
            fiveDay: '/api/plate-funds-flow/fiveDay',
            tenDay: '/api/plate-funds-flow/tenDay'
        };

        // 字段映射
        const FIELD_MAP = {
            name: { label: '名称', sortable: true },
            code: { label: '编号', sortable: true },
            price: { label: '股价', sortable: true },
            changePercent: { label: '涨跌幅', sortable: true },
            mainNetInflow: { label: '主力净流入', sortable: true },
            mainInflowRatio: { label: '主力净占比', sortable: true },
            superLargeNetInflow: { label: '超大单净流入', sortable: true },
            superLargeInflowRatio: { label: '超大单净占比', sortable: true },
            largeNetInflow: { label: '大单净流入', sortable: true },
            largeInflowRatio: { label: '大单净占比', sortable: true },
            midNetInflow: { label: '中单净流入', sortable: true },
            midInflowRatio: { label: '中单净占比', sortable: true },
            smallNetInflow: { label: '小单净流入', sortable: true },
            smallInflowRatio: { label: '小单净占比', sortable: true },
            topStock: { label: '主力净流入最大股', sortable: true }
        };

        // 当前状态
        let currentData = [];
        let filteredData = [];
        let currentSort = { field: null, direction: 'desc' };
        let currentPeriod = 'today';

        // DOM元素
        const tableContainer = document.getElementById('tableContainer');
        const totalCountEl = document.getElementById('totalCount');
        const todayBtn = document.getElementById('todayBtn');
        const fiveDayBtn = document.getElementById('fiveDayBtn');
        const tenDayBtn = document.getElementById('tenDayBtn');
        const searchInput = document.getElementById('searchInput');

        // 格式化数值
        function formatNumber(num, decimals = 2) {
            if (num === undefined || num === null) return '-';

            if (typeof num === 'number') {
                // 对于大额资金，根据数值大小选择单位
                const absNum = Math.abs(num);
                if (absNum >= 100000000) { // 1亿及以上
                    return (num / 100000000).toFixed(decimals) + '亿';
                } else if (absNum >= 10000) { // 1万及以上
                    return (num / 10000).toFixed(decimals) + '万';
                } else {
                    // 小于1万的数值，保留最多两位小数
                    return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
                }
            }

            return String(num);
        }

        // 获取数据
        async function fetchData(period) {
            try {
                tableContainer.innerHTML = '<div class="loading">正在加载数据...</div>';

                const response = await fetch(API_ENDPOINTS[period]);
                const result = await response.json();

                if (!result.success || !result.data?.data?.diff) {
                    throw new Error(result.error || '数据获取失败');
                }

                currentData = formatPlateFundsData(result.data.data.diff,period);
                // 初始化过滤数据
                filteredData = [...currentData];
                totalCountEl.textContent = `共${filteredData.length}条记录`;

                renderTable(filteredData);
            } catch (error) {
                console.error('获取数据失败:', error);
                tableContainer.innerHTML = `<div class="error">加载数据失败: ${error.message}</div>`;
            }
        }

        // 搜索过滤功能
        function filterData(searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') {
                filteredData = [...currentData];
            } else {
                const term = searchTerm.toLowerCase().trim();
                filteredData = currentData.filter(item => {
                    // 搜索名称(f14)或编号(f12)
                    return (
                        (item.name && item.name.toLowerCase().includes(term)) ||
                        (item.code && item.code.toLowerCase().includes(term))
                    );
                });
            }

            // 更新计数并重新渲染表格
            totalCountEl.textContent = `共${filteredData.length}条记录`;

            // 如果当前有排序，则应用相同的排序
            if (currentSort.field) {
                const sortedFilteredData = [...filteredData].sort((a, b) => {
                    let valA = a[currentSort.field];
                    let valB = b[currentSort.field];

                    // 处理数字比较
                    if (typeof valA === 'number' && typeof valB === 'number') {
                        return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                    }

                    // 处理字符串比较
                    if (typeof valA === 'string' && typeof valB === 'string') {
                        return currentSort.direction === 'asc' ?
                            valA.localeCompare(valB) :
                            valB.localeCompare(valA);
                    }

                    // 混合类型比较
                    valA = String(valA || '');
                    valB = String(valB || '');

                    return currentSort.direction === 'asc' ?
                        valA.localeCompare(valB) :
                        valB.localeCompare(valA);
                });

                renderTable(sortedFilteredData);
            } else {
                renderTable(filteredData);
            }
        }

        // 渲染表格
        function renderTable(data) {
            if (!data || data.length === 0) {
                tableContainer.innerHTML = '<div class="error">暂无数据</div>';
                return;
            }

            // 创建表头
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
            `;
            
            for (const [field, config] of Object.entries(FIELD_MAP)) {
                const className = config.sortable ? 'sortable' : '';
                const sortClass = 
                    currentSort.field === field ? 
                    (currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc') : 
                    '';
                    
                tableHTML += `
                    <th 
                        class="${className} ${sortClass}" 
                        data-field="${field}"
                        title="点击排序"
                    >
                        ${config.label}
                    </th>
                `;
            }
            
            tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 创建表格内容
            data.forEach(item => {
                tableHTML += '<tr>';
                
                for (const [field] of Object.entries(FIELD_MAP)) {
                    let cellValue = item[field];
                    let cellClass = '';
                    
                    // 特殊格式化
                    if (field === 'changePercent' || field === 'mainInflowRatio' || field === 'superLargeInflowRatio' || field === 'largeInflowRatio' || field === 'midInflowRatio' || field === 'smallInflowRatio') {
                        // 百分比字段
                        if (typeof cellValue === 'number') {
                            cellValue = cellValue.toFixed(2) + '%';
                        } else {
                            cellValue = cellValue + '%';
                        }
                        // 涨用红色(positive)，跌用绿色(negative)
                        cellClass = cellValue && parseFloat(cellValue.replace('%', '')) >= 0 ? 'positive percent' : 'negative percent';
                    } else if (field === 'price') {
                        // 股价字段 - 不要转换为万元，正常显示
                        cellValue = typeof cellValue === 'number' ? cellValue.toFixed(2) : cellValue;
                        // 根据涨跌幅决定股价颜色，涨用红色，跌用绿色
                        cellClass = item.changePercent >= 0 ? 'positive' : 'negative';
                    } else if (field === 'mainNetInflow' || field === 'superLargeNetInflow' || field === 'largeNetInflow' || field === "midNetInflow" || field === 'smallNetInflow') {
                        // 资金流入字段（原始数据是元，使用通用格式化）
                        if (typeof cellValue === 'number') {
                            cellValue = formatNumber(cellValue, 2);
                        }
                        // 资金净流入为正用红色(positive)，负用绿色(negative)
                        cellClass = cellValue && parseFloat(String(cellValue).replace(/[万亿]/g, '')) >= 0 ? 'positive amount' : 'negative amount';
                    } else {
                        // 其他字段
                        if (typeof cellValue === 'number') {
                            cellValue = formatNumber(cellValue, 2);
                        }
                    }
                    
                    tableHTML += `<td class="${cellClass}">${cellValue || '-'}</td>`;
                }
                
                tableHTML += '</tr>';
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
            
            // 添加排序事件监听器
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.getAttribute('data-field');
                    handleSort(field);
                });
            });
        }

        // 处理排序
        function handleSort(field) {
            // 如果点击的是同一个字段，则切换排序方向
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // 点击新字段，默认降序
                currentSort.field = field;
                currentSort.direction = 'desc';
            }
            
            // 执行排序
            const sortedData = [...currentData].sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                
                // 处理数字比较
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                }
                
                // 处理字符串比较
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return currentSort.direction === 'asc' ? 
                        valA.localeCompare(valB) : 
                        valB.localeCompare(valA);
                }
                
                // 混合类型比较
                valA = String(valA || '');
                valB = String(valB || '');
                
                return currentSort.direction === 'asc' ? 
                    valA.localeCompare(valB) : 
                    valB.localeCompare(valA);
            });
            
            renderTable(sortedData);
        }

        // 切换时间周期
        function switchPeriod(period) {
            currentPeriod = period;
            
            // 更新按钮状态
            todayBtn.classList.toggle('active', period === 'today');
            fiveDayBtn.classList.toggle('active', period === 'fiveDay');
            tenDayBtn.classList.toggle('active', period === 'tenDay');
            
            // 获取新数据
            fetchData(period);
        }

        // 初始化事件监听器
        todayBtn.addEventListener('click', () => switchPeriod('today'));
        fiveDayBtn.addEventListener('click', () => switchPeriod('fiveDay'));
        tenDayBtn.addEventListener('click', () => switchPeriod('tenDay'));

        // 添加搜索框事件监听器
        searchInput.addEventListener('input', (e) => {
            filterData(e.target.value);
        });


        /**
         * 格式化板块资金流数据，便于前端显示
         * @param {Array} diffData - 来自API的diff数组
         * @returns {Array} 格式化后的数据
         */
        function formatPlateFundsData(diffData,period) {
            if (!Array.isArray(diffData)) {
                return [];
            }
            if(period === 'today') {
                return diffData.map(item => ({
                    code: item.f12,           // 板块代码
                    name: item.f14,           // 板块名称
                    price: item.f2,           // 板块股价
                    changePercent: item.f3,   // 涨跌幅%
                    mainNetInflow: item.f62,  // 主力净流入-净额
                    mainInflowRatio: item.f184, // 主力流入-净占比%
                    superLargeNetInflow: item.f66, // 超大单净流入-净额
                    superLargeInflowRatio: item.f69, // 超大单净流入-净占比%
                    largeNetInflow: item.f72,       // 大单净流入-净额
                    largeInflowRatio: item.f75,     // 大单净流入-净占比%
                    midNetInflow: item.f78,         // 中单净流入-净额
                    midInflowRatio: item.f81,       // 中单净流入-净占比%
                    smallNetInflow: item.f84,       // 小单净流入-净额
                    smallInflowRatio: item.f87,     // 小单净流入-净占比%
                    topStock: item.f204,            // 主力净流入最大股
                    topStockCode: item.f205         // 主力净流入最大股代码
                }));
            }else if (period === 'fiveDay') {
                return diffData.map(item => ({
                    code: item.f12,           // 板块代码
                    name: item.f14,           // 板块名称
                    price: item.f2,           // 板块股价
                    changePercent: item.f109,   // 涨跌幅%
                    mainNetInflow: item.f164,  // 主力净流入-净额
                    mainInflowRatio: item.f165, // 主力流入-净占比%
                    superLargeNetInflow: item.f166, // 超大单净流入-净额
                    superLargeInflowRatio: item.f167, // 超大单净流入-净占比%
                    largeNetInflow: item.f168,       // 大单净流入-净额
                    largeInflowRatio: item.f169,     // 大单净流入-净占比%
                    midNetInflow: item.f170,         // 中单净流入-净额
                    midInflowRatio: item.f171,       // 中单净流入-净占比%
                    smallNetInflow: item.f172,       // 小单净流入-净额
                    smallInflowRatio: item.f173,     // 小单净流入-净占比%
                    topStock: item.f257,            // 主力净流入最大股
                    topStockCode: item.f258         // 主力净流入最大股代码
                }));
            }else{
                return diffData.map(item => ({
                    code: item.f12,           // 板块代码
                    name: item.f14,           // 板块名称
                    price: item.f2,           // 板块股价
                    changePercent: item.f160,   // 涨跌幅%
                    mainNetInflow: item.f174,  // 主力净流入-净额
                    mainInflowRatio: item.f175, // 主力流入-净占比%
                    superLargeNetInflow: item.f176, // 超大单净流入-净额
                    superLargeInflowRatio: item.f177, // 超大单净流入-净占比%
                    largeNetInflow: item.f178,       // 大单净流入-净额
                    largeInflowRatio: item.f179,     // 大单净流入-净占比%
                    midNetInflow: item.f180,         // 中单净流入-净额
                    midInflowRatio: item.f181,       // 中单净流入-净占比%
                    smallNetInflow: item.f182,       // 小单净流入-净额
                    smallInflowRatio: item.f183,     // 小单净流入-净占比%
                    topStock: item.f260,            // 主力净流入最大股
                    topStockCode: item.f261         // 主力净流入最大股代码
                }));
            }
        }
        // 初始化页面
        fetchData('today');
    </script>
</body>
</html>