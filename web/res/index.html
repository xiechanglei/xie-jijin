<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基金持仓列表</title>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            width: 100%;
            padding: 15px;
        }
        .summary {
            background: #e9f7ef;
            border-radius: 6px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .summary-item {
            display: flex;
            flex-direction: column;
        }
        .summary-label {
            font-size: 0.8em;
            color: #666;
        }
        .summary-value {
            font-weight: bold;
            font-size: 1.1em;
        }
        .positive {
            color: #dc3545; /* Red for positive */
        }
        .negative {
            color: #28a745; /* Green for negative */
        }
        .summary-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: #e9f7ef;
            border-radius: 6px;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            padding: 10px;
            border-radius: 6px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .delete-btn {
            background: #dc3545;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            /*table-layout: fixed; !* Fixed table layout to prevent overflow *!*/
        }
        th, td {
            padding: 8px;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        th {
            font-weight: bold;
            background: transparent; /* Remove header background */
        }
        tr:hover {
            background-color: #f1f1f1 !important;
        }
        tbody tr:nth-child(even) {
            background-color: transparent;
        }
        tbody tr:nth-child(odd) {
            background: #fafafa;
        }
        .code-col { width: 6%; }
        .name-col { width: 16%; }
        .base-col { width: 6%; }
        .estimate-col { width: 6%; }
        .change-percent-col { width: 6%; }
        .time-col { width: 10%; }
        .shares-col { width: 8%; }
        .amount-col { width: 8%; }
        .change-amount-col { width: 8%; }
        .action-col { width: 4%; }
        .error {
            color: #dc3545;
            padding: 10px;
            background: #fdeaea;
            border-radius: 4px;
            margin: 10px 0;
        }
        .set-shares-btn {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            display: inline-block;
            margin-left: 5px;
        }

        .set-shares-btn:hover {
            color: #007bff;
            background: transparent;
        }

        .gund-link{
            cursor: pointer;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="summary-container">
            <div class="summary">
                <div class="summary-item">
                    <span class="summary-label">持仓总金额</span>
                    <span class="summary-value" id="totalAmount">0.00</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">总涨跌幅</span>
                    <span class="summary-value" id="totalChangePercent">0.00%</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">涨跌金额</span>
                    <span class="summary-value" id="totalChangeAmount">0.00</span>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <input type="text" id="fundCodeInput" placeholder="基金代码" />
                    <input type="number" id="fundShareInput" placeholder="持仓份额" step="0.01" />
                </div>
                <div class="control-group">
                    <button id="addFundBtn">添加基金</button>
                    <button id="refreshBtn">刷新数据</button>
                    <button id="plateFlowBtn">查看板块资金流</button>
                </div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <table id="fundsTable">
            <thead>
                <tr>
                    <th class="code-col">基金代码</th>
                    <th class="name-col">基金名称</th>
                    <th class="base-col">基准值</th>
                    <th class="estimate-col">实时估算值</th>
                    <th class="change-percent-col">涨跌幅</th>
                    <th class="time-col">估算时间</th>
                    <th class="shares-col">持仓份额</th>
                    <th class="amount-col">持仓金额</th>
                    <th class="change-amount-col">涨跌金额</th>
                    <th class="action-col"></th>
                </tr>
            </thead>
            <tbody id="fundsTableBody">
                <!-- Fund data will be populated here -->
            </tbody>
        </table>
    </div>

    <script>
        // Auto-refresh interval (10 minutes = 600000 milliseconds)
        let refreshInterval;
        let isRefreshing = false; // Flag to prevent concurrent refreshes

        // Load funds data when page loads
        window.onload = function() {
            loadFunds();
            // Set up auto-refresh every 10 minutes
            refreshInterval = setInterval(loadFunds, 60 * 1000);

            // Set up event listeners for controls
            document.getElementById('addFundBtn').addEventListener('click', addFund);
            document.getElementById('refreshBtn').addEventListener('click', loadFunds);
            document.getElementById('plateFlowBtn').addEventListener('click', goToPlateFlow);
        };

        function goToPlateFlow() {
            window.location.href = '/plate-fund-flow.html';
        }

        async function addFund() {
            const codeInput = document.getElementById('fundCodeInput');
            const shareInput = document.getElementById('fundShareInput');
            const code = codeInput.value.trim();
            const share = parseFloat(shareInput.value);

            if (!code) {
                alert('请输入基金代码');
                return;
            }

            if (isNaN(share) || share < 0) {
                alert('请输入有效的持仓份额');
                return;
            }

            try {
                // Call the backend API to add the fund
                const response = await fetch('/api/add-fund', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        amount: share // amount represents shares
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Clear inputs
                codeInput.value = '';
                shareInput.value = '';

                // Add fund to table immediately with placeholder data
                addFundToTable(code, share);

                // Then fetch real-time data for the newly added fund
                await updateFundRealTimeData(code);
            } catch (error) {
                console.error('Error adding fund:', error);
                alert('添加基金失败: ' + error.message);
            }
        }

        async function removeFund(code) {
            if (!confirm(`确定要删除基金 ${code} 吗？`)) {
                return;
            }

            try {
                // Call the backend API to remove the fund
                const response = await fetch('/api/remove-fund', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Remove fund from table immediately
                removeFundFromTable(code);
            } catch (error) {
                console.error('Error removing fund:', error);
                alert('删除基金失败: ' + error.message);
            }
        }

        async function setShare(code) {
            const newShare = prompt(`请输入基金 ${code} 的新持仓份额:`);
            if (newShare === null) return; // User cancelled

            const share = parseFloat(newShare);
            if (isNaN(share) || share < 0) {
                alert('请输入有效的持仓份额');
                return;
            }

            try {
                // Call the backend API to set the fund share
                const response = await fetch('/api/set-share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        share: share
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Update the fund's share in the table immediately
                updateFundShareInTable(code, share);

                // Then fetch real-time data for the updated fund to update all dependent columns
                await updateFundRealTimeData(code);

                // Update summary statistics after the data is refreshed
                updateSummaryStats();
            } catch (error) {
                console.error('Error setting fund share:', error);
                alert('设置持仓份额失败: ' + error.message);
            }
        }

        async function loadFunds() {
            // Prevent concurrent refreshes
            if (isRefreshing) {
                return;
            }

            isRefreshing = true;
            const errorEl = document.getElementById('error');
            const tableEl = document.getElementById('fundsTable');
            const tableBodyEl = document.getElementById('fundsTableBody');

            // Hide error during refresh
            errorEl.style.display = 'none';

            try {
                // Step 1: Get fund codes from local storage (only basic info)
                const response = await fetch('/api/funds');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (!data.funds || !Array.isArray(data.funds)) {
                    throw new Error('Invalid response format');
                }

                // Step 2: Process funds - add new ones, update existing ones
                for (const fund of data.funds) {
                    const existingRow = tableBodyEl.querySelector(`tr[data-code="${fund.code}"]`);
                    if (existingRow) {
                        // Update existing fund's shares
                        const cells = existingRow.cells;
                        cells[6].querySelector('.shares-value').textContent = (fund.shares || 0).toFixed(2); // Update shares (now in cell 6)
                    } else {
                        // Add new fund to table with placeholder data
                        addFundToTable(fund.code, fund.shares || 0, 'N/A', 0);
                    }
                }

                // Remove funds that are no longer in the list (deleted by user)
                const existingRows = tableBodyEl.querySelectorAll('tr[data-code]');
                existingRows.forEach(row => {
                    const code = row.getAttribute('data-code');
                    const existsInData = data.funds.some(fund => fund.code === code);
                    if (!existsInData) {
                        row.remove();
                    }
                });

                // Always show the table
                tableEl.style.display = 'table';

                // Step 3: Fetch real-time data for each fund
                for (const fund of data.funds) {
                    await updateFundRealTimeData(fund.code);
                }

                // Re-sort the table after all data is loaded
                sortTableByAmount();

            } catch (error) {
                console.error('Error loading funds:', error);
                errorEl.textContent = '加载基金数据失败: ' + error.message;
                errorEl.style.display = 'block';
            } finally {
                isRefreshing = false;
            }
        }

        function addFundToTable(code, shares, name = 'N/A', baseValue = 0) {
            const tableBodyEl = document.getElementById('fundsTableBody');

            // Check if fund already exists in table
            const existingRow = tableBodyEl.querySelector(`tr[data-code="${code}"]`);
            if (existingRow) {
                return; // Fund already in table
            }

            const row = document.createElement('tr');
            row.setAttribute('data-code', code);

            row.innerHTML = `
                <td>${code}</td>
                <td class="gund-link"><a onclick="openFundDetail('${code}')"><span>${name}</span> <svg class="icon" style="width: 1em;height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M574 665.4c-3.1-3.1-8.2-3.1-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8c-3.1-3.1-8.2-3.1-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zM832.6 191.4c-84.6-84.6-221.5-84.6-306 0L410.3 307.6c-3.1 3.1-3.1 8.2 0 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6c-3.1 3.1-3.1 8.2 0 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1zM610.1 372.3c-3.1-3.1-8.2-3.1-11.3 0L372.3 598.7c-3.1 3.1-3.1 8.2 0 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z"></path></svg></a></td>
                <td>${baseValue.toFixed(4)}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td class="shares-cell">
                    <span class="shares-value">${shares.toFixed(2)}</span>
                    <button class="set-shares-btn" onclick="setShare('${code}')">
                        <svg class="icon" style="width: 1em; height: 1em; vertical-align: middle; fill: currentColor; overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
                            <path d="M656 310.4c35.2-38.4 76.8-96 76.8-156.8 0-35.2-9.6-64-32-86.4-41.6-41.6-115.2-41.6-198.4-41.6l-22.4 0c-12.8 0-25.6 0-38.4 0-76.8 0-140.8-3.2-182.4 38.4-22.4 22.4-32 51.2-32 89.6 0 86.4 76.8 163.2 112 192 12.8 12.8 35.2 9.6 44.8-3.2 12.8-12.8 9.6-35.2-3.2-44.8-54.4-48-89.6-102.4-89.6-144 0-32 9.6-41.6 12.8-44.8 22.4-19.2 76.8-19.2 137.6-19.2 12.8 0 25.6 0 41.6 0l25.6 0c67.2 0 131.2 0 153.6 22.4C662.4 115.2 672 124.8 672 153.6c0 38.4-35.2 92.8-92.8 140.8-9.6 6.4-12.8 19.2-9.6 28.8 3.2 9.6 9.6 19.2 19.2 25.6 118.4 44.8 243.2 166.4 243.2 332.8 0 156.8-96 214.4-352 214.4s-352-57.6-352-214.4c0-96 44.8-192 124.8-262.4 12.8-12.8 16-32 3.2-44.8-12.8-12.8-32-16-44.8-3.2-92.8 83.2-147.2 195.2-147.2 310.4 0 278.4 281.6 278.4 416 278.4s416 0 416-278.4C899.2 528 800 384 656 310.4zM611.2 467.2c12.8-12.8 12.8-32 0-44.8-12.8-12.8-32-12.8-44.8 0l-80 76.8-80-76.8c-12.8-12.8-32-12.8-44.8 0-12.8 12.8-12.8 32 0 44.8l89.6 86.4 0 19.2-64 0c-19.2 0-32 12.8-32 32s12.8 32 32 32l64 0 0 32-64 0c-19.2 0-32 12.8-32 32s12.8 32 32 32l64 0L451.2 800c0 19.2 12.8 32 32 32s32-12.8 32-32l0-67.2 64 0c19.2 0 32-12.8 32-32s-12.8-32-32-32l-64 0 0-32 64 0c19.2 0 32-12.8 32-32s-12.8-32-32-32l-64 0 0-12.8L611.2 467.2z"></path>
                        </svg>
                    </button>
                </td>
                <td>-</td>
                <td>-</td>
                <td class="action-cell">
                    <button class="delete-btn" onclick="removeFund('${code}')">删除</button>
                </td>
            `;

            tableBodyEl.appendChild(row);
        }

        function removeFundFromTable(code) {
            const tableBodyEl = document.getElementById('fundsTableBody');
            const row = tableBodyEl.querySelector(`tr[data-code="${code}"]`);
            if (row) {
                row.remove();
            }
        }

        function updateFundShareInTable(code, newShare) {
            const tableBodyEl = document.getElementById('fundsTableBody');
            const row = tableBodyEl.querySelector(`tr[data-code="${code}"]`);
            if (row) {
                const cells = row.cells;
                cells[6].querySelector('.shares-value').textContent = newShare.toFixed(2); // Update shares (now in cell 6)
            }
        }

        async function updateFundRealTimeData(code) {
            try {
                const gzResponse = await fetch(`/api/fund-gz/${code}`);
                if (!gzResponse.ok) {
                    console.error(`Failed to fetch real-time data for fund ${code}`);
                    return;
                }

                const gzData = await gzResponse.json();
                const estimatedValue = parseFloat(gzData.gsz || 0);
                const time = gzData.gztime || '-';
                const name = gzData.name || 'N/A';

                // Find the row for this fund
                const tableBodyEl = document.getElementById('fundsTableBody');
                const row = tableBodyEl.querySelector(`tr[data-code="${code}"]`);

                // Only update if the fund still exists in the table (hasn't been deleted)
                if (row) {
                    const cells = row.cells;

                    // Get current shares from the table
                    const share = parseFloat(cells[6].querySelector('.shares-value').textContent) || 0; // Shares are in cell 6

                    // Update name (cell 1) and base value (cell 2) from the real-time data
                    cells[1].querySelector("span").textContent = name;
                    // Update base value if it was a placeholder
                    if (cells[2].textContent === '0.0000' || cells[2].textContent === '0' || cells[2].textContent === 'N/A') {
                        // If base value was placeholder, update it with dwjz from real-time data
                        cells[2].textContent = parseFloat(gzData.dwjz || 0).toFixed(4);
                    } else {
                        // If base value already exists, keep the existing value but ensure it's properly formatted
                        const existingBaseValue = parseFloat(cells[2].textContent);
                        if (!isNaN(existingBaseValue)) {
                            cells[2].textContent = existingBaseValue.toFixed(4);
                        }
                    }

                    // Calculate the change percentage between estimated value and base value
                    const baseValue = parseFloat(cells[2].textContent) || parseFloat(gzData.dwjz) || 0;
                    const changePercent = baseValue !== 0 ? ((estimatedValue - baseValue) / baseValue) * 100 : 0;

                    // Calculate amounts based on estimated value
                    const estimatedAmount = estimatedValue * share;
                    const baseAmount = baseValue * share;
                    const profitAmount = estimatedAmount - baseAmount;

                    // Update the cells with real-time data
                    cells[3].textContent = estimatedValue.toFixed(4); // Real-time estimate value
                    cells[4].textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`; // Change percentage (between est and base)
                    cells[5].textContent = time; // Estimate time
                    cells[7].textContent = estimatedAmount.toFixed(2); // Holdings amount
                    cells[8].textContent = `${profitAmount >= 0 ? '+' : ''}${profitAmount.toFixed(2)}`; // Change amount

                    // Update color classes for profit/loss
                    cells[4].className = changePercent >= 0 ? 'positive' : 'negative'; // Change percentage
                    cells[8].className = profitAmount >= 0 ? 'positive' : 'negative'; // Change amount
                }
            } catch (error) {
                console.error(`Error updating real-time data for fund ${code}:`, error);
            }
        }

        function sortTableByAmount() {
            const tableBodyEl = document.getElementById('fundsTableBody');
            const rows = Array.from(tableBodyEl.querySelectorAll('tr'));

            // Sort rows by estimated amount (column 7 - 持仓金额)
            rows.sort((a, b) => {
                const amountA = parseFloat(a.cells[7].textContent) || 0;
                const amountB = parseFloat(b.cells[7].textContent) || 0;
                return amountB - amountA; // Descending order
            });

            // Re-append rows in sorted order
            rows.forEach(row => tableBodyEl.appendChild(row));

            // Update summary statistics after sorting
            updateSummaryStats();
        }

        function updateSummaryStats() {
            const tableBodyEl = document.getElementById('fundsTableBody');
            const rows = tableBodyEl.querySelectorAll('tr');

            let totalAmount = 0;
            let totalChangeAmount = 0;

            for (const row of rows) {
                const amount = parseFloat(row.cells[7].textContent) || 0; // Holdings amount (was incorrectly using cell 6 which is shares)
                const changeAmount = parseFloat(row.cells[8].textContent.replace(/[^\d.-]/g, '')) || 0; // Change amount

                totalAmount += amount;
                totalChangeAmount += changeAmount;
            }

            // Calculate total change percentage
            const totalChangePercent = totalAmount !== 0 ? (totalChangeAmount / totalAmount) * 100 : 0;

            // Update the summary elements
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
            document.getElementById('totalChangeAmount').textContent = `${totalChangeAmount >= 0 ? '+' : ''}${totalChangeAmount.toFixed(2)}`;
            document.getElementById('totalChangePercent').textContent = `${totalChangePercent >= 0 ? '+' : ''}${totalChangePercent.toFixed(2)}%`;

            // Apply color classes
            const changePercentElement = document.getElementById('totalChangePercent');
            const changeAmountElement = document.getElementById('totalChangeAmount');

            changePercentElement.className = 'summary-value ' + (totalChangePercent >= 0 ? 'positive' : 'negative');
            changeAmountElement.className = 'summary-value ' + (totalChangeAmount >= 0 ? 'positive' : 'negative');
        }

        // Open fund detail page in a new tab
        function openFundDetail(code) {
            window.open(`/fund-detail.html?code=${code}`, '_blank');
        }

        // Make functions available globally for inline event handlers
        window.removeFund = removeFund;
        window.setShare = setShare;
        window.loadFunds = loadFunds;
        window.openFundDetail = openFundDetail;
    </script>
</body>
</html>